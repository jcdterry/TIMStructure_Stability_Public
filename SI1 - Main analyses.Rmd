---
title: "Supplementary Information 1: Main Analysis"
author: "Chris Terry"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction 

This document outlines the code used in the analyses carried out for the paper.

## Packages and Sourcing
```{r message=FALSE, warning=FALSE}
require(igraph)
require(MASS)
require(tidyverse)
require(pracma)
require(moments)
require(rmutil)
require(cowplot)
require(knitr)
require(mvtnorm)
require(mgcv)
library(Cairo) 
sapply(paste0('Scripts/',list.files('Scripts/')), source)->tmp
```

# Conducting Stability Analyses of Artificial Webs

The top-level function is `RunArtificialWebAnalysis()`. 

Arguments are details of the trophic network are specified (to be passed to `BuildWeb`), along with the details (model, density and strength) of the TIMs to be added (passed to `AddTIMsToMatrix`). Different TIM distribution models are each generated by a separate function, named `AddxxxxxTIM()`. The short names used here are slightly different to those used in the paper.

`RunArtificialWebAnalysis` returns a single large data.frame where each row is an differently randomly generated model iteration and large number of columns detailing the model used, various structural features and the stability (calculated with `StabilityCriterion`, `RowColStructure`,`TIM_Dist_Examine` and `CalcDegHetero` functions ). 

As a side effect these are saved as an R-object in the working directory, as per `Name`. For convenience I have also include a csv file of the generated data used in the Main Text.

The function used code used to generate the data for the artificial webs using three different specifications of predator-prey interactions:

```{r}
TIMModels<-c( 'Nearby', 'Far',
              'Normal', 'Random','Positive',
              'Negative','TightRecip','Switching')
```

```{r eval=FALSE}
### Build sets of trophic networks
Repeats = 100

UnbalancedNetworks <- lapply(1:Repeats,BuildWeb,
                             size= 60,connectance  = 0.2,
                             mux=-5, muy=1,sigmax=2, sigmay = 0.5, rhoxy=-0.8)

FREQ_TO_TEST <- seq( 0, 30, by = 2)

data<-RunArtificialWebAnalysis(Name = 'Generated Data/MainResults',
                               TrophicNetworks = UnbalancedNetworks,
                               TIMStrength = 0.5,
                               Models = TIMModels,
                               FREQ_TO_TEST = FREQ_TO_TEST )

save(data, file='Generated Data/MainResults3')

```

### Loading data
```{r}
load('Generated Data/MainResults3')
```

# Main Text Figures

## Figure 2: Demonstration of Interaction Matrices

```{r, message=FALSE, warning=FALSE}
set.seed(1)

J <- BuildWeb(mux = -1 , muy = 1,
              sigmax = 0.5, sigmay = 0.5, size=20,
              rhoxy = -0.8, connectance =0.2)
C <-  AddTIMsToMatrix(J,'Random',TIM_Dens = 5, TIMStrength = 0.5) 

ExampleB <- PlotMatrix(J, '')
ExampleA<-PlotMatrix(C, '')
ExampleC<-PlotMatrix(C-J, '')

Combined <- plot_grid(ExampleB, ExampleC, ExampleA,  ncol=3)

labels = c('A\nFull Interaction Matrix',
           'B\n Trophic Interactions',
           'C\nNon-Trophic Interactions')                     
Combined
ggsave('Paper/Figures/ExampleMatrices.png', width = 10,height = 4, dpi =200 )
```

## Figure 3: Example TIM matrices by different distributions. 

`PlotTIMMatrices()` can access the different TIM models and return coloured matrix 

```{r, fig.height=12, fig.width=12}
ModelList <- c( 'Normal','Nearby', 'Far','TightRecip',
                'Positive', 'Negative',
                'Switching' )

matLABELS<- c('Baseline Model',
              'Near Modifications Only', 
              'Far Modifications Only',  
              'Facilitating Modifications',
              'Interfering Modifications',
              'Reciprocal Modifications',
              'Mutual Interference')

Lettered_Labels <- paste0(c('',  paste0(letters[1:6],') ') ),matLABELS)

Top1 <- PlotTIMMatrices(ModelList[1],Lettered_Labels[1], J, 8, 0.5 )
Lower6 <- plot_grid(plotlist = map2(ModelList[-1],Lettered_Labels[-1],
                                    .f =  PlotTIMMatrices,
                                    J, 8, 0.5 ),
                    ncol = 3, label_size = 6 )

plot_grid(Top1, Lower6,ncol=1, rel_heights = c(1,2))

ggsave('Paper/Figures/SuppInfo/AllTIMMatrices.png', width = 8,height = 9, bg = 'white' )
ggsave('Paper/Figures/SuppInfo/AllTIMMatrices.pdf', width = 8,height = 9, bg = 'white'  )

```


## Figure Theme
```{r}
MODEL_COLOURS <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                   "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

MODEL_LABELS<- c('Switching'= 'f) Mutual Interference',
                 'Normal' =   'Random TIM Model',
                 'Positive' =  'c) Facilitating Modifications',
                 'Negative' =  'd) Interfering Modifications',
                 'Random' = 'Random NTEs',
                 'TightRecip'= 'e) Reciprocal Modifications',
                 'Nearby'=  'a) Nearby TIMs Only',
                 'Far' =  'b) Far TIMs Only')

MODEL_BREAKS <-  c(  'Random','Normal'  ,
                     'Nearby','Far' ,  
                     'Positive' , 'Negative' ,
                     'TightRecip',  'Switching')
```

## Figure 4 Network Structure Properties

```{r}
data %>%
  gather('Response', 'Value',
         Tot_Conn , NT_Conn , C_VAR , ABothHet , rho,  cov     )%>%
  mutate(Response = factor(Response,
                           levels= c('Tot_Conn' , 'NT_Conn' , 'C_VAR' , 'ABothHet' , 'rho',  'cov' ),
                           labels = Labels <- c('a) Overall\nConnectance' , 
                                                'b) Non-Trophic Effect\nConnectance' , 
                                                'c) Non-Trophic Effect\nVariance',
                                                'd) Overall\nDegree Heterogeneity',
                                                'e) Overall\nPairwise Correlation',
                                                'f) Trophic v Non-Trophic\nCovariance')))-> DF_stats

ggplot(DF_stats, aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth( se = FALSE, alpha=0.5)+
  facet_wrap(~Response, scales = 'free' )+
  scale_colour_manual(values=MODEL_COLOURS, 
                      labels=MODEL_LABELS,
                      breaks =MODEL_BREAKS,
                      name = 'Distribution Model:')+  
  theme(strip.background = element_blank(),
        strip.text = element_text(hjust = 0.05,
                                  size = 12, 
                                  margin = margin(1,1,1,1)),
        legend.position = 'bottom')+
  labs(title="",  y='Network Metric', 
       x='TIM Frequency') -> NETWORK_STTRUCTURE_FIGURE

NETWORK_STTRUCTURE_FIGURE

ggsave('Paper/Figures/MainText/Figure_structure.pdf',NETWORK_STTRUCTURE_FIGURE, width = 9, height = 9)
ggsave('Paper/Figures/MainText/Figure_structure.png',NETWORK_STTRUCTURE_FIGURE, width = 9, height = 9, dpi=300)

```

## Figure 5: Impact of TIMs on Stability in Artificial Webs

```{r message=FALSE}

data %>%
  mutate(Instability = log(obs)) %>%
  gather('Response', 'Value',
         Instability,  Omega_d2 )%>%
  mutate(Response = factor(Response,
                           levels= c('Instability',  'Omega_d2'),
                           labels = Labels <- c('a) Instability', 
                                                'b) Feasibility Domain')))-> df


ggplot(filter(df, Response == 'a) Instability'), aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth( se = FALSE, alpha=0.5)+
  scale_colour_manual(values=MODEL_COLOURS, 
                      labels=MODEL_LABELS,
                      breaks =MODEL_BREAKS)+  
  theme(legend.position = 'none')+
  labs(title="a) Instability",  y='𝕽(λ1)', 
       x='TIM Frequency')-> Instability_subfigure

ggplot(filter(df, Response == 'b) Feasibility Domain'), aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth( se = FALSE, alpha=0.5)+
  scale_colour_manual(values=MODEL_COLOURS, 
                      labels=MODEL_LABELS,
                      breaks =MODEL_BREAKS,
                      name = 'Distribution\nModel:')+  
  theme(legend.position = 'bottom')+
  guides(col=guide_legend(nrow=4,byrow=TRUE))+
  labs(title='b) Feasibility Domain',  y='ω(A)', 
       x='TIM Frequency')-> Feasibility_subfigure

Figure_dynamics<- plot_grid(Instability_subfigure,
                            Feasibility_subfigure ,
                            ncol=1,
                            rel_heights = c(4,6))
Figure_dynamics


ggsave('Paper/Figures/MainText/Figure_dynamics.pdf',Figure_dynamics, width = 5, height = 9, device = cairo_pdf )
ggsave('Paper/Figures/MainText/Figure_dynamics.png',Figure_dynamics, width = 5, height = 9, dpi=300)

```

## SI Feasibility uder varying self-regulation

```{r}

data %>%
  gather('Response', 'Value',
         Omega,Omega_d2,Omega_d5 )%>%
  mutate(Response = factor(Response,
                           levels= c( 'Omega_d2','Omega','Omega_d5'),
                           labels = Labels <- c('a) Main text result\n(Self-regulation = -2)', 
                                                'b) Self-regulation = 0', 
                                                'c) Self-regulation = -5')))-> df_feasSI

ggplot(df_feasSI, aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth( se = FALSE, alpha=0.5)+
  facet_wrap(~Response, scales = 'free' )+
  scale_colour_manual(values=MODEL_COLOURS, 
                      labels=MODEL_LABELS,
                      breaks = MODEL_BREAKS,
                      name = 'Distribution Model:')+  
  theme(strip.background = element_blank(),
        strip.text = element_text(hjust = 0.05,
                                  size = 12, 
                                  margin = margin(1,1,1,1)),
        legend.position = 'bottom')+
  labs(title="",  y='Size of Feasibility Domain', 
       x='TIM Frequency')



ggsave('Paper/Figures/SuppInfo/SR_compareFeas.pdf', width = 9, height = 5)
ggsave('Paper/Figures/SuppInfo/SR_compareFeas.png', width = 9, height =5, dpi=300)

```

# Session Info

```{r}
sessionInfo()
```

